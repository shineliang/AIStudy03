# AI智能体系统需求文档

## 1. 项目概述

本项目旨在开发一个基于LangChain框架的AI智能体系统，支持用户通过自然语言对话方式与AI交互。系统包含React前端和Python后端，通过多种工具和记忆能力增强AI智能体的功能，为用户提供高效、智能的对话体验。

## 2. 前端需求
目录： frontend

### 2.1 技术规范
- **开发框架**：React
- **启动端口**：3000
- **通信方式**：支持Stream模式接收AI响应

### 2.2 用户界面设计

#### 2.2.1 主对话界面
- 提供用户输入区和智能体响应展示区
- 支持Stream模式，实时显示AI回复
- 对话开始时显示推荐问题
- 每次对话完成后显示相关推荐问题

#### 2.2.2 侧边栏功能
- **历史对话侧边栏**
  - 通过按钮在右侧打开
  - 显示与智能体的全部历史对话记录
  - 支持按时间排序和搜索功能

- **工具使用记录侧边栏**
  - 显示智能体使用的所有工具记录
  - 包含工具调用参数、调用结果和调用时间
  - 支持按工具类型筛选

- **记忆记录侧边栏**
  - 显示智能体的记忆内容
  - 包含记忆类型、记忆内容和创建时间
  - 支持按记忆类型筛选

## 3. 后端需求
目录： backend

### 3.1 技术规范
- **开发语言**：Python
- **数据库**：SQLite
- **框架**：LangChain脚手架
- **启动端口**：5100
- **通信模式**：Stream模式和Function Calling模式

### 3.2 架构组件
- LangChain的Agent框架
- LangChain的工具框架
- LangChain的记忆框架
- LangChain的对话框架
- LangChain的链式框架
- LangChain的提示框架
- LangChain的模型框架

### 3.3 工具功能实现

#### 3.3.1 高德地图天气API
- **功能**：查询指定城市的天气信息
- **接口**：`https://restapi.amap.com/v3/weather/weatherInfo?city={city}&key={apikey}`
- **参数**：
  - city：城市名称或代码
  注意：key：API密钥 (从环境变量获取)
- **返回**：当前天气信息，包括温度、湿度、风向等

#### 3.3.2 抖音热搜API
- **功能**：查询当前抖音热搜榜单
- **接口**：`https://apis.tianapi.com/douyinhot/index`
- **调用方式**：
  ```
  curl -X POST \
  -H "Content-Type:application/x-www-form-urlencoded" \
  -d "key=d985a36207259613bd1cddb600f8b87b" \
  "https://apis.tianapi.com/douyinhot/index"
  ```
  注意：key：API密钥 (从环境变量获取)
- **返回**：当前抖音热搜榜单内容

#### 3.3.3 考勤记录查询
- **功能**：查询指定日期范围内的考勤记录
- **参数**：
  - start_date：开始日期（必填）
  - end_date：结束日期（可选）
- **数据源**：SQLite数据库attendance表
- **返回**：符合日期范围的考勤记录列表

#### 3.3.4 排班信息查询
- **功能**：查询指定日期范围内的排班信息
- **参数**：
  - start_date：开始日期（必填）
  - end_date：结束日期（可选）
- **数据源**：SQLite数据库shift表
- **返回**：符合日期范围的排班信息列表

#### 3.3.5 请假申请
- **功能**：创建请假申请记录
- **参数**：
  - date：请假日期
  - type：请假类型
  - duration：请假时长
  - reason：请假原因
- **数据操作**：在SQLite数据库leave表中创建或修改记录
- **返回**：请假申请结果

## 4. 数据库设计

### 4.1 数据表结构

#### 4.1.1 考勤记录表(attendance)
| 字段名 | 类型 | 描述 |
|-------|------|------|
| date  | TEXT | 日期 |
| time  | TEXT | 时间 |
| type  | TEXT | 类型（签到/签退）|

#### 4.1.2 排班信息表(shift)
| 字段名 | 类型 | 描述 |
|-------|------|------|
| name  | TEXT | 姓名 |
| date  | TEXT | 日期 |
| detail| TEXT | 排班详情 |

#### 4.1.3 请假记录表(leave)
| 字段名 | 类型 | 描述 |
|-------|------|------|
| date  | TEXT | 请假日期 |
| type  | TEXT | 请假类型 |
| duration | TEXT | 请假时长 |
| reason | TEXT | 请假原因 |

### 4.2 模拟数据

#### 4.2.1 考勤记录模拟数据
```sql
CREATE TABLE attendance (date TEXT, time TEXT, type TEXT);
INSERT INTO attendance VALUES
    ("2025-03-01", "09:00", "签到"),
    ("2025-03-01", "18:00", "签退"),
    ("2025-03-02", "09:15", "签到"),
    ("2025-03-02", "17:45", "签退"),
    ("2025-03-04", "08:50", "签到"),
    ("2025-03-04", "18:30", "签退"),
    ("2025-03-05", "08:50", "签到"),
    ("2025-03-05", "18:30", "签退"),
    ("2025-03-06", "08:50", "签到"),
    ("2025-03-06", "18:30", "签退"),
    ("2025-03-07", "08:50", "签到"),
    ("2025-03-07", "18:30", "签退");
```

#### 4.2.2 排班信息模拟数据
```sql
CREATE TABLE shift (name TEXT, date TEXT, detail TEXT);
INSERT INTO shift VALUES
    ("钟晓樑", "2025-02-17", "周一:上午09:00-下午05:00(保洁)"),
    ("钟晓樑", "2025-02-18", "周二:上午10:00-下午12:00(保洁) 下午13:00 -下午06:00(值班)"),
    ("钟晓樑", "2025-02-19", "周三:上午10:00-下午12:00(保洁) 下午13:00 -下午06:00(值班)"),
    ("钟晓樑", "2025-02-20", "周四:上午9:00-下午5:00(保洁)"),
    ("钟晓樑", "2025-02-21", "周五:上午8:00-下午4:00(值班)"),
    ("钟晓樑", "2025-02-22", "周六:休息"),
    ("钟晓樑", "2025-02-23", "周日:休息"),
    ("钟晓樑", "2025-03-01", "周六:休息"),
    ("钟晓樑", "2025-03-02", "周日:休息"),
    ("钟晓樑", "2025-03-03", "周一:上午09:00-下午05:00(保洁)"),
    ("钟晓樑", "2025-03-04", "周二:上午10:00-下午12:00(保洁) 下午13:00 -下午06:00(值班)"),
    ("钟晓樑", "2025-03-05", "周三:上午10:00-下午12:00(保洁) 下午13:00 -下午06:00(值班)"),
    ("钟晓樑", "2025-03-06", "周四:上午9:00-下午5:00(保洁)"),
    ("钟晓樑", "2025-03-07", "周五:上午8:00-下午4:00(值班)"),
    ("钟晓樑", "2025-03-08", "周六:休息"),
    ("钟晓樑", "2025-03-09", "周日:休息"),
    ("钟晓樑", "2025-03-10", "周一:上午09:00-下午05:00(保洁)"),
    ("钟晓樑", "2025-03-11", "周二:上午10:00-下午12:00(保洁) 下午13:00 -下午06:00(值班)"),
    ("钟晓樑", "2025-03-12", "周三:休息"),
    ("钟晓樑", "2025-03-13", "周四:上午9:00-下午5:00(保洁)"),
    ("钟晓樑", "2025-03-14", "周五:上午8:00-下午4:00(值班)"),
    ("钟晓樑", "2025-03-15", "周六:上午9:00 下午2:00(值班)"),
    ("钟晓樑", "2025-03-16", "周日:休息");
```

#### 4.2.3 请假记录模拟数据
```sql
CREATE TABLE leave (date TEXT, type TEXT, duration TEXT, reason TEXT);
INSERT INTO leave VALUES
    ("2025-03-01", "事假", "1小时", "家里有事"),
    ("2025-03-02", "病假", "2小时", "感冒发烧"),
    ("2025-03-03", "事假", "1小时", "家里有事"),
    ("2025-03-04", "病假", "2小时", "感冒发烧");
```

## 5. API接口设计

### 5.1 对话接口
- **路径**：`/api/chat`
- **方法**：POST
- **描述**：获取AI对话回复
- **请求体**：
  ```json
  {
    "message": "用户输入的消息"
  }
  ```
- **响应**：流式返回AI回复内容

### 5.2 历史记录接口
- **路径**：`/api/history`
- **方法**：GET
- **描述**：获取历史对话记录
- **响应**：
  ```json
  {
    "history": [
      {
        "user": "用户消息",
        "ai": "AI回复",
        "timestamp": "2025-03-09 16:00:00"
      }
    ]
  }
  ```

### 5.3 工具使用记录接口
- **路径**：`/api/tool-usage`
- **方法**：GET
- **描述**：获取工具使用记录
- **响应**：
  ```json
  {
    "tool_usages": [
      {
        "tool_name": "天气查询",
        "parameters": {"city": "北京"},
        "result": "当前气温15℃，晴",
        "timestamp": "2025-03-09 16:05:00"
      }
    ]
  }
  ```

### 5.4 记忆记录接口
- **路径**：`/api/memories`
- **方法**：GET
- **描述**：获取记忆记录
- **响应**：
  ```json
  {
    "memories": [
      {
        "type": "用户偏好",
        "content": "用户经常查询北京的天气",
        "created_at": "2025-03-09 15:30:00"
      }
    ]
  }
  ```

### 5.5 推荐问题接口
- **路径**：`/api/suggested-questions`
- **方法**：GET
- **描述**：获取推荐问题
- **参数**：context（可选，上下文信息）
- **响应**：
  ```json
  {
    "questions": [
      "今天北京的天气怎么样？",
      "查询我本周的排班信息",
      "我要申请明天下午的事假"
    ]
  }
  ```

## 6. 系统流程

### 6.1 用户对话流程
1. 用户在前端输入问题
2. 前端通过API将问题发送给后端
3. 后端的LangChain Agent处理问题
4. Agent根据需要调用相应工具
5. 处理结果通过Stream模式返回给前端
6. 前端实时显示AI回复
7. 对话完成后显示相关推荐问题

### 6.2 工具调用流程
1. Agent分析用户意图，决定使用哪个工具
2. 使用Function Calling格式准备工具调用参数
3. 执行工具调用，获取结果
4. 记录工具使用信息
5. 将工具结果融入回复内容
6. 返回给用户完整响应

## 7. 实现注意事项

1. 确保API密钥安全存储，不要硬编码在前端代码中
2. 实现错误处理机制，妥善处理API调用失败等异常情况
3. 优化Stream模式性能，确保响应平滑流畅
4. 针对所有工具实现合适的参数验证逻辑
5. 确保数据库操作的安全性，防止SQL注入等问题
6. 实现适当的日志记录功能，方便问题排查

## 8. 验收标准

1. 前端能正常展示对话、历史记录、工具使用记录和记忆记录
2. Stream模式正常工作，实时显示AI回复
3. 所有工具能被正确调用并返回结果
4. 数据库操作正常，能够查询和记录相关信息
5. 系统响应时间满足用户体验要求
6. 推荐问题功能正常工作

此需求文档作为开发团队的指导依据，后续实现过程可能根据技术条件和项目进展进行适当调整。